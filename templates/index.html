<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente Inteligente de Men√∫ Gastron√≥mico</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="messenger-container">
    <div class="chat-sidebar">
      <div class="chat-header">
        <h1>Asistente Chef</h1>
      </div>
      <div class="chat-info">
        <p>Este asistente te ayudar√° a generar un men√∫ personalizado para tu restaurante.</p>
      </div>
      <div class="creator-info">
        <h2 style="color: #000;">Sobre el Creador</h2>
        <div class="creator-profile">
          <img src="https://avatars.githubusercontent.com/u/72231436?v=4" alt="Sebastian Jaque" class="creator-img">
            <h3 style="color: #000;">Sebastian Jaque</h3>
            <p class="creator-role" style="color: #000;">Desarrollador & Estudiante</p>
          </div>
          <div class="app-details">
            <p style="color: #000;"><strong style="color: #000;">Versi√≥n:</strong> 1.0.0</p>
            <p style="color: #000;"><strong style="color: #000;">√öltima actualizaci√≥n:</strong> Junio 2025</p>
            <p style="color: #000;"><strong style="color: #000;">Tecnolog√≠as:</strong> Python, Flask, OpenAI API</p>
          </div>
          <div class="contact-info">
            <h4 style="color: #000;">Contacto</h4>
            <p style="color: #000;">üéì Estudiante de Diplomado en IA</p>
            <p style="color: #000;">üíª Programador Junior</p>
            <p style="color: #000;">üìß sjaquer@outlook.es</p>
        </div>
      </div>
    </div>

    <div class="chat-main">
      <div class="chat-header">
        <div class="chat-header-info">
          <img src="{{ url_for('static', filename='chef_ico.webp') }}" alt="Chef Assistant">
          <span>Asistente Chef</span>
          <span class="status-dot"></span>
        </div>
      </div>

      <div class="chat-messages" id="chat-messages">
        <!-- Aqu√≠ se agregar√°n los mensajes din√°micamente -->
        <div class="message system">
          <div class="message-content">
            Hola, soy tu asistente chef. Para generar un men√∫ personalizado, necesito algunos datos:
          </div>
        </div>
      </div>

      <!-- Formulario oculto que mantiene la l√≥gica original -->
      <form id="menu-form" style="display: none;">
        <input type="text" id="perfil_cliente" name="perfil_cliente">
        <input type="text" id="presupuesto" name="presupuesto">
        <input type="text" id="tiempo_max" name="tiempo_max">
        <input type="text" id="estilo" name="estilo">
        <input type="text" id="ingredientes" name="ingredientes">
        <input type="text" id="restricciones" name="restricciones">
      </form>

      <div class="chat-input-container">
        <input type="text" id="user-input" placeholder="Escribe tu respuesta...">
        <button id="send-btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Definir las preguntas
    const questions = [
        { 
            field: 'perfil_cliente', 
            question: '¬øCu√°l es el perfil de tus clientes? Por ejemplo: familias con ni√±os, ejecutivos, turistas, etc.'
        },
        { 
            field: 'presupuesto', 
            question: '¬øCu√°l es el presupuesto m√°ximo que deseas por plato? Por ejemplo: 20 soles, 15 euros, etc.)'
        },
        { 
            field: 'tiempo_max', 
            question: '¬øCu√°nto tiempo m√°ximo de preparaci√≥n deseas por plato? Por ejemplo: 30 minutos, 1 hora, etc.'
        },
        { 
            field: 'estilo', 
            question: '¬øQu√© estilo de cocina deseas para tu men√∫? Por ejemplo: fusi√≥n peruana-japonesa, alemana etc.'
        },
        { 
            field: 'ingredientes', 
            question: '¬øQu√© ingredientes tienes disponibles? Puedes listarlos o mencionar los m√°s importantes.'
        },
        { 
            field: 'restricciones', 
            question: '¬øHay alguna restricci√≥n diet√©tica o alergia que deba considerar? Por ejemplo: sin gluten, sin l√°cteos, vegetariano, etc.'
        }
    ];

    // Variable global para seguir la pregunta actual
    let currentQuestion = 0;

    // Funci√≥n para mostrar el indicador de escritura
    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        document.getElementById('chat-messages').appendChild(indicator);
        return indicator;
    }

    // Funci√≥n para remover el indicador de escritura
    function removeTypingIndicator(indicator) {
        if (indicator) indicator.remove();
    }

    // Funci√≥n para agregar mensajes al chat
    function addMessage(content, type = 'system') {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        if (content.includes('Men√∫ Personalizado')) {
            // Formatear el men√∫ para mejor presentaci√≥n
            const formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .split('\n\n').map(section => {
                    if (section.includes('NOMBRE DEL PLATO')) {
                        return `<div class="menu-section">
                            <div class="menu-item">
                                <div class="menu-item-header">
                                    ${section.split('\n')[0]}
                                </div>
                                <div class="menu-item-content">
                                    <div class="dish-details">
                                        ${section.split('\n').slice(1).join('\n')}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                    return section;
                }).join('\n');
        
            messageDiv.innerHTML = `
                <div class="message-content menu-response">
                    <div class="menu-text">${formattedContent}</div>
                </div>
            `;
            
            // Agregar bot√≥n para hacer preguntas adicionales
            setTimeout(() => {
                addMessage("¬øTienes alguna pregunta sobre el men√∫ generado? Puedo ayudarte con:", 'system');
                addQuickReplies([
                    "Modificar alg√∫n plato",
                    "Ajustar precios",
                    "Cambiar ingredientes",
                    "Preguntar sobre preparaci√≥n",
                    "Solicitar otro men√∫"
                ]);
            }, 1000);
        } else {
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${content}
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Agregar al array de quickReplies existente
    function addQuickReplies(options) {
        options.push("Sobre el creador");  // A√±adir opci√≥n sobre el creador

        const quickRepliesDiv = document.createElement('div');
        quickRepliesDiv.className = 'quick-replies';
        
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'quick-reply-btn';
            button.textContent = option;
            button.onclick = () => handleQuickReply(option);
            quickRepliesDiv.appendChild(button);
        });
        
        document.getElementById('chat-messages').appendChild(quickRepliesDiv);
    }

    // Funci√≥n para manejar las respuestas r√°pidas
    async function handleQuickReply(option) {
        if (option === "Sobre el creador") {
            const creatorInfo = `
                **Sobre el Creador** üë®‚Äçüíª

                Sebastian Jaque es un apasionado desarrollador de software y estudiante del Diplomado en Inteligencia Artificial. 
                
                **Experiencia y Estudios:**
                - Desarrollador Junior con experiencia en Python y Web
                - Estudiante de Diplomado en IA
                - Fotograf√≠a y dise√±o gr√°fico como pasatiempos
                
                **Sobre esta Aplicaci√≥n:**
                Esta aplicaci√≥n fue desarrollada como proyecto final del Diplomado, combinando tecnolog√≠as modernas como Python, Flask y la API de OpenAI para crear una herramienta √∫til en el √°mbito gastron√≥mico.
                
                **Objetivo del Proyecto:**
                Facilitar la creaci√≥n de men√∫s personalizados utilizando IA, ayudando a chefs y restaurantes a optimizar sus ofertas gastron√≥micas.

                **Contacto:**
                üìß sjaquer@outlook.es
                üåê github.com/sjaquer
            `;
            
            addMessage(creatorInfo, 'system');
            return;
        }
        try {
        const menuContent = document.querySelector('.menu-response .menu-text');
        const previousMenu = menuContent ? menuContent.textContent : '';
        
        // Mostrar la opci√≥n seleccionada como mensaje del usuario
        addMessage(option, 'user');
        
        // Mostrar indicador de escritura
        const indicator = showTypingIndicator();

        const response = await fetch("/api/chat", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: option,
                context: "menu_followup",
                previousMenu: previousMenu,
                lastQuestion: option  // A√±adir la √∫ltima pregunta para contexto
            })
        });

        const data = await response.json();
        removeTypingIndicator(indicator);

        if (data.error) {
            addMessage("Lo siento, hubo un error: " + data.error, 'system');
            return;
        }

        // Mostrar la respuesta de la IA
        if (data.response) {
            addMessage(data.response, 'system');

            // Si es solicitud de nuevo men√∫
            if (data.action === "restart") {
                setTimeout(() => {
                    currentQuestion = 0;
                    document.querySelectorAll('#menu-form input').forEach(input => input.value = '');
                    askNextQuestion();
                }, 1000);
            } else {
                // Mostrar nuevas opciones despu√©s de cada respuesta
                setTimeout(() => {
                    addQuickReplies([
                        "Modificar otro plato",
                        "Hacer otra pregunta",
                        "Solicitar otro men√∫"
                    ]);
                }, 1000);
            }
        }
    } catch (error) {
        console.error("Error:", error);
        addMessage("Lo siento, hubo un error al procesar tu solicitud.", 'system');
    }
}

    // Agregar despu√©s de handleQuickReply
    async function handleOpenQuestion(question) {
        addMessage(question, 'user');
        
        const indicator = showTypingIndicator();
        
        try {
            const menuContent = document.querySelector('.menu-response .menu-text');
            const previousMenu = menuContent ? menuContent.textContent : '';
            
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: question,
                    context: "open_question",
                    previousMenu: previousMenu
                })
            });

            const data = await response.json();
            removeTypingIndicator(indicator);

            if (data.response) {
                addMessage(data.response, 'system');
                
                // Agregar opciones de seguimiento
                if (data.followUpOptions) {
                    setTimeout(() => {
                        addMessage("¬øHay algo m√°s en lo que pueda ayudarte?", 'system');
                        addQuickReplies([
                            "Hacer otra pregunta",
                            "Modificar el men√∫",
                            "Solicitar otro men√∫"
                        ]);
                    }, 1000);
                }
            }
        } catch (error) {
            removeTypingIndicator(indicator);
            addMessage("Lo siento, hubo un error al procesar tu solicitud.", 'system');
        }
    }

    // Funci√≥n para hacer la siguiente pregunta
    function askNextQuestion() {
        if (currentQuestion < questions.length) {
            const indicator = showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator(indicator);
                addMessage(questions[currentQuestion].question);
            }, 1000);
        } else {
            // Procesar el formulario cuando todas las preguntas han sido respondidas
            processForm();
        }
    }

    // Funci√≥n para procesar el formulario
    async function processForm() {
        // Obtener todos los valores como texto
        const formData = {
            perfil_cliente: document.getElementById('perfil_cliente').value.trim(),
            presupuesto: document.getElementById('presupuesto').value.trim(),
            tiempo_max: document.getElementById('tiempo_max').value.trim(),
            estilo: document.getElementById('estilo').value.trim(),
            ingredientes: document.getElementById('ingredientes').value.trim(),
            restricciones: document.getElementById('restricciones').value.trim()
        };

        // Validar que ning√∫n campo est√© vac√≠o
        if (Object.values(formData).some(value => !value)) {
            addMessage("Por favor, completa todos los campos antes de generar el men√∫.", 'system');
            return;
        }

        try {
            const indicator = showTypingIndicator();
            addMessage("Generando tu men√∫ personalizado...", 'system');

            const response = await fetch("/api/generate-menu", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            removeTypingIndicator(indicator);

            if (data.menu) {
                const formattedMenu = `Men√∫ Personalizado\n\n${data.menu}`;
                addMessage(formattedMenu, 'system');
            } else if (data.error) {
                addMessage(`Error: ${data.error}`, 'system');
            } else {
                addMessage("Hubo un error al generar el men√∫. Por favor, intenta de nuevo.", 'system');
            }
        } catch (error) {
            removeTypingIndicator(indicator);
            addMessage("Error al comunicarse con el servidor.", 'system');
            console.error("Error:", error);
        }
    }

    // Funci√≥n para manejar las respuestas del usuario
    function handleUserInput() {
        const userInput = document.getElementById('user-input');
        const value = userInput.value.trim();
        
        if (!value) return;

        // Si es una pregunta sobre el creador
        if (value.toLowerCase().includes('creador') || value.toLowerCase().includes('creator')) {
            showCreatorInfo();
            userInput.value = ''; // Limpiar input
            return;
        }

        // Si estamos en modo chat (despu√©s del men√∫)
        if (currentQuestion >= questions.length) {
            addMessage(value, 'user');
            handleOpenQuestion(value);
            userInput.value = ''; // Limpiar input
            return;
        }

        // Si estamos en el formulario inicial
        addMessage(value, 'user');
        const field = questions[currentQuestion].field;
        document.getElementById(field).value = value;
        userInput.value = ''; // Limpiar input
        currentQuestion++;
        askNextQuestion();
    }

    // Agregar funci√≥n para mostrar info del creador
    function showCreatorInfo() {
        const creatorInfo = `
            **Sobre el Creador** üë®‚Äçüíª

            Mi creador es Sebastian Jaque, un desarrollador de software y estudiante 
            del Diplomado en Inteligencia Artificial.

            **Experiencia y Estudios:**
            - üéì Estudiante de Diplomado en IA
            - üíª Programador Junior con experiencia en Python y desarrollo web
            - üì∏ Aficionado a la fotograf√≠a y dise√±o gr√°fico

            **Sobre esta Aplicaci√≥n:**
            Esta aplicaci√≥n fue desarrollada como proyecto final del Diplomado,
            utilizando tecnolog√≠as modernas como Python, Flask y la API de OpenAI.

            **Contacto:**
            üìß sjaquer@outlook.es
            üåê github.com/sjaquer
        `;
        
        addMessage(creatorInfo, 'system');
        
        // Agregar opciones de continuaci√≥n
        setTimeout(() => {
            addQuickReplies([
                "Volver al men√∫",
                "Hacer una pregunta",
                "Solicitar otro men√∫"
            ]);
        }, 1000);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Listener para el bot√≥n de enviar
        document.getElementById('send-btn').addEventListener('click', handleUserInput);

        // Listener para la tecla Enter
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleUserInput();
            }
        });

        // Iniciar la conversaci√≥n con la primera pregunta
        askNextQuestion();
    });
</script>
</body>
</html>
